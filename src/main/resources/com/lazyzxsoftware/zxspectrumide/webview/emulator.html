<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ZX Spectrum IDE</title>
    <style>
        body {
            background-color: #2b2b2b;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }

        #game-container {
            width: 320px;
            height: 240px;
            border: 20px solid #101010;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            image-rendering: pixelated;
            width: 100% !important;
            height: 100% !important;
        }

        .status-msg {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
    </style>

    <script src="js/jsspeccy-core.min.js"></script>
    <script src="js/autoloaders.js"></script>

</head>
<body>

<div id="game-container">
    <div id="speccy"></div>
</div>

<div id="status" class="status-msg">Estado...</div>

<script>
    var emulator = null;

    // =========================================================================
    // üíâ EL INTERCEPTOR (Monkey Patch)
    // =========================================================================
    // Este bloque intercepta la creaci√≥n del procesador Z80 dentro de JSSpeccy
    // para capturar y exponer el objeto 'memory' antes de que quede oculto.
    // Esto es necesario para que el Debugger y el Visor de Memoria funcionen.
    if (window.JSSpeccy && window.JSSpeccy.Z80) {
        var originalZ80 = window.JSSpeccy.Z80;

        window.JSSpeccy.Z80 = function(opts) {
            // 1. Creamos la instancia original
            var z80Instance = originalZ80(opts);

            // 2. Le inyectamos la memoria p√∫blica si est√° disponible en las opciones
            if (opts.memory) {
                z80Instance.memory = opts.memory;
                console.log("üîì Memoria RAM desbloqueada para acceso externo.");
            }
            return z80Instance;
        };
    } else {
        console.error("‚ùå No se pudo aplicar el parche de memoria (JSSpeccy no cargado).");
    }

    // =========================================================================
    // 1. PUENTE Y ARRANQUE
    // =========================================================================

    function initBridge() {
        if (window.javaApp) {
            // log("Conectado a Java.");
            window.javaApp.requestRomLoad();
        } else {
            setTimeout(initBridge, 200);
        }
    }

    function startEmulatorWithRom(romBase64) {
        try {
            var opts = {
                'autostart': true,
                'scaleFactor': 2,
                'machine': '48',
                'romURL': "data:application/octet-stream;base64," + romBase64
            };

            emulator = JSSpeccy('speccy', opts);

            // Verificaci√≥n para Java
            if (emulator && emulator.getZ80 && emulator.getZ80().memory) {
                if(window.javaApp) window.javaApp.log("‚úÖ Acceso a RAM nativa: OK");
            }

            if(window.javaApp) window.javaApp.onEmulatorReady();

        } catch (e) {
            error("Error arranque: " + e);
        }
    }

    // =========================================================================
    // 2. CARGA DE PROGRAMAS (.TAP)
    // =========================================================================

    function loadProgramFromJava(base64Data, filename) {
        try {
            var binaryString = window.atob(base64Data);
            var len = binaryString.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            var blob = new Blob([bytes], {type: 'application/octet-stream'});
            var tapeUrl = URL.createObjectURL(blob);

            if (emulator) {
                // Asegurar foco y audio
                window.focus();
                if (emulator.audio && emulator.audio.context && emulator.audio.context.state === 'suspended') {
                    emulator.audio.context.resume();
                }

                // Carga con auto-arranque (autoloaders.js escribir√° LOAD "")
                emulator.loadFromUrl(tapeUrl, {'autoload': true});
            }
        } catch (e) {
            error("Error carga: " + e.message);
        }
    }

    // =========================================================================
    // 3. SISTEMA DE DEBUG (Event Driven)
    // =========================================================================

    // =========================================================================
    // 3. SISTEMA DE DEBUG (Event Driven)
    // =========================================================================

    function setupDebugHooks() {
        console.log("Entro en setupDebugHooks");
        if (emulator && emulator.getZ80) {
            var z80 = emulator.getZ80();
            z80.setDebugCallback(function(reason, addr) {
                emulator.stop();
                console.log("Llamando a notifyJavaPaused");
                notifyJavaPaused(reason);
            });
        }
    }

    function notifyJavaPaused(reason) {
        if (!emulator) return;
        var z80 = emulator.getZ80();

        var pc = z80.getPC();
        var memStart = 0;
        var memSize = 65536;
        var fullRamB64 = getBase64Memory(memStart, memSize);
        // --------------------------

        var logData = (typeof z80.getTraceLog === 'function') ? z80.getTraceLog() : null;

        // --- DIAGN√ìSTICO ---
        // 1. Verificar si la funci√≥n existe
        if (typeof z80.getTraceLog !== 'function') {
            alert("ERROR CR√çTICO: z80.getTraceLog no existe. Revisa el min.js");
            console.error("z80.getTraceLog is undefined");
            return;
        }

        console.log("DEBUG: Longitud del Log recuperado: " + (logData ? logData.length : "NULL"));
        if (!logData) {
            alert("ERROR: z80.getTraceLog() devolvi√≥ vac√≠o/null");
        }
        // -------------------

        var state = {
            reason: reason || "paused",
            pc: pc,
            sp: z80.getSP(),
            af: z80.getAF(), bc: z80.getBC(), de: z80.getDE(), hl: z80.getHL(),
            ix: z80.getIX(), iy: z80.getIY(),
            af_: z80.getAF_(), bc_: z80.getBC_(), de_: z80.getDE_(), hl_: z80.getHL_(),
            im: z80.getIM(), iff1: z80.getIFF1(), iff2: z80.getIFF2(),

            // Enviamos la RAM completa
            previewMemStart: memStart,
            previewMem: fullRamB64,

            traceLog: logData
        };

        if (window.javaApp) {
            window.javaApp.onEmulatorPaused(JSON.stringify(state));
        }
    }

    function getBase64Memory(addr, size) {
        var bytes = [];
        var mem = emulator.getZ80().memory;
        for(var i=0; i<size; i++) bytes.push(mem.read((addr+i)&0xFFFF));
        return window.btoa(String.fromCharCode.apply(null, new Uint8Array(bytes)));
    }

    /**
     * Funci√≥n llamada desde Java (fetchMemory) para leer un bloque de RAM
     * bajo demanda y devolverlo as√≠ncronamente.
     */
    function readMemoryBlock(addr, size) {
        if (!emulator) return;
        // Reutilizamos la funci√≥n auxiliar que ya tienes
        var b64 = getBase64Memory(addr, size);

        // Devolvemos el resultado a Java
        if (window.javaApp) {
            window.javaApp.onMemoryRead(addr, b64);
        }
    }

    // Comandos desde Java
    function setBreakpoints(addrArray) {
        if (!emulator) return;
        var z80 = emulator.getZ80();
        z80.clearBreakpoints();
        for (var i=0; i<addrArray.length; i++) {
            z80.setBreakpoint(addrArray[i], true);
        }
        log("Breakpoints actualizados: " + addrArray.length);
    }

    // Sobrescribimos el startEmulatorWithRom para inyectar los hooks
    var oldStart = startEmulatorWithRom;
    startEmulatorWithRom = function(rom) {
        oldStart(rom);
        setTimeout(setupDebugHooks, 500); // Dar tiempo a que arranque
    };

    // =========================================================================
    // 4. UTILIDADES
    // =========================================================================

    function sendReport(report) {
        if (window.javaApp && report.status === "success") {
            try {
                // Intentamos usar el m√©todo completo (con memoria)
                if (window.javaApp.updateDebugDataFull) {
                    window.javaApp.updateDebugDataFull(
                        report.af, report.bc, report.de, report.hl,
                        report.af_, report.bc_, report.de_, report.hl_,
                        report.ix, report.iy, report.sp, report.pc,
                        report.memoryBase64 || ""
                    );
                } else {
                    // Fallback
                    window.javaApp.updateDebugData(
                        report.af, report.bc, report.de, report.hl,
                        report.af_, report.bc_, report.de_, report.hl_,
                        report.ix, report.iy, report.sp, report.pc
                    );
                }
            } catch(e) {}
        }
    }

    function log(msg) {
        var el = document.getElementById('status');
        el.innerText = msg;
        el.style.display = 'block';
        if(window.javaApp) window.javaApp.log(msg);
        setTimeout(function() { el.style.display = 'none'; }, 3000);
    }

    function error(msg) {
        var el = document.getElementById('status');
        el.innerText = "ERROR: " + msg;
        el.style.display = 'block';
        el.style.color = '#ff5555';
        if(window.javaApp) window.javaApp.log(msg);
    }

    window.onerror = function(msg) { error("JS Global: " + msg); };
    window.onload = function() { setTimeout(initBridge, 100); };

    // REDIRECCI√ìN DE LOGS: Para ver console.log en IntelliJ
    (function(){
        var oldLog = console.log;
        console.log = function(message) {
            oldLog.apply(console, arguments);
            if (window.javaApp) {
                window.javaApp.log(message); // Enviar a Java
            }
        };

        var oldError = console.error;
        console.error = function(message) {
            oldError.apply(console, arguments);
            if (window.javaApp) {
                // Puedes crear javaApp.error(msg) o usar log con prefijo
                window.javaApp.log("ERROR: " + message);
            }
        };
    })();
</script>
</body>
</html>