<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ZX Spectrum IDE</title>
    <style>
        body {
            background-color: #2b2b2b;
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; color: #0f0; font-family: monospace;
            overflow: hidden;
        }

        #game-container {
            width: 640px; height: 480px;
            border: 20px solid #101010;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #000;
            display: flex; justify-content: center; align-items: center;
        }

        canvas {
            image-rendering: pixelated;
            width: 100% !important; height: 100% !important;
        }

        .status-msg {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.8); color: white; padding: 5px;
            font-size: 12px; pointer-events: none; z-index: 100;
            display: none;
        }
    </style>

    <script src="js/z80.js"></script>
    <script src="js/jsspeccy-core.min.js"></script>
    <script src="js/autoloaders.js"></script>

</head>
<body>

<div id="game-container">
    <div id="speccy"></div>
</div>

<div id="status" class="status-msg">Estado...</div>

<script>
    var emulator = null;
    var currentRomUrl = null;

    function initBridge() {
        if (window.javaApp) {
            log("Conectado. Solicitando ROM...");
            window.javaApp.requestRomLoad();
        } else {
            setTimeout(initBridge, 200);
        }
    }

    function startEmulatorWithRom(romBase64) {
        try {
            currentRomUrl = "data:application/octet-stream;base64," + romBase64;

            var opts = {
                'autostart': true,
                'scaleFactor': 2,
                'machine': '48',
                'romURL': currentRomUrl
            };

            emulator = JSSpeccy('speccy', opts);

            log("Sistema listo.");
            if(window.javaApp) {
                window.javaApp.log("ðŸš€ Emulador Inicializado.");
                // --- AVISAMOS A JAVA DE QUE YA PUEDE MANDAR EL TAPE ---
                window.javaApp.onEmulatorReady();
            }

        } catch (e) {
            error("Error arranque: " + e);
        }
    }

    function loadProgramFromJava(base64Data, filename) {
        log("ðŸ“¥ Cargando: " + filename);
        try {
            var binaryString = window.atob(base64Data);
            var len = binaryString.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            var blob = new Blob([bytes], {type: 'application/octet-stream'});
            var tapeUrl = URL.createObjectURL(blob);

            if (emulator) {
                // Truco para despertar el AudioContext si estaba en pausa
                window.focus();
                if (emulator.audio && emulator.audio.context && emulator.audio.context.state === 'suspended') {
                    emulator.audio.context.resume();
                }

                emulator.loadFromUrl(tapeUrl, {'autoload': true});
                if(window.javaApp) window.javaApp.log("âœ… Programa inyectado.");
            } else {
                error("Emulador no listo (esto no deberÃ­a pasar con la cola de Java).");
            }

        } catch (e) {
            error("Error carga: " + e.message);
        }
    }

    // ... (MantÃ©n el resto de funciones log, error, debugTest igual que antes) ...
    // ... AsegÃºrate de que debugTest y sendReport sigan ahÃ­ ...

    // --- COPIA AQUÃ EL RESTO DE FUNCIONES DE TU VERSIÃ“N ANTERIOR ---
    // (log, error, sendReport, debugTest, window.onerror, window.onload)
    // -----------------------------------------------------------------
    function log(msg) {
        var el = document.getElementById('status');
        el.innerText = msg;
        el.style.display = 'block';
        if(window.javaApp) window.javaApp.log(msg);
        setTimeout(function() { el.style.display = 'none'; }, 3000);
    }

    function error(msg) {
        var el = document.getElementById('status');
        el.innerText = "ERROR: " + msg;
        el.style.display = 'block';
        el.style.color = '#ff5555';
        if(window.javaApp) window.javaApp.log(msg);
    }

    window.onerror = function(msg) { error("JS Global: " + msg); };
    window.onload = function() { setTimeout(initBridge, 100); };

    function sendReport(report) {
        if (window.javaApp && report.status === "success") {
            window.javaApp.updateDebugData(
                report.af || 0, report.bc || 0, report.de || 0, report.hl || 0,
                report.af_ || 0, report.bc_ || 0, report.de_ || 0, report.hl_ || 0,
                report.ix || 0, report.iy || 0, report.sp || 0, report.pc || 0
            );
        }
    }

    function debugTest() {
        var report = { status: "fail" };
        try {
            if (emulator && emulator.getZ80) {
                var z80 = emulator.getZ80();
                if (z80) {
                    report.status = "success";
                    report.pc = z80.getPC();
                    report.sp = z80.getSP();
                    report.af = z80.getAF();
                    report.bc = z80.getBC();
                    report.de = z80.getDE();
                    report.hl = z80.getHL();
                    report.ix = z80.getIX();
                    report.iy = z80.getIY();
                    if(z80.getAF_Alt) report.af_ = z80.getAF_Alt();
                    if(z80.getBC_Alt) report.bc_ = z80.getBC_Alt();
                    if(z80.getDE_Alt) report.de_ = z80.getDE_Alt();
                    if(z80.getHL_Alt) report.hl_ = z80.getHL_Alt();
                }
            }
        } catch (e) {}
        sendReport(report);
    }
</script>
</body>
</html>